#!/usr/bin/env bash

dest=$HOME/Pictures/Screenshots
progname=$(basename $0)

[ -r $HOME/.config/screenshotrc ] && source $HOME/.config/screenshotrc

! which jq &> /dev/null && echo "Error: jq package required" && exit 1
! which notify-send &> /dev/null && echo "Error: libnotify package required" && exit 1
! which grim &> /dev/null && echo "Error: grim package required" && exit 1
! which slurp &> /dev/null && echo "Error: slurp package required" && exit 1
! which wl-copy &> /dev/null && echo "Error: wl-clipboard package required" && exit 1

usage() {
  echo "usage: $progname [-h] [-w|-a|-s]"
  exit $1
}

aswitch=false
sswitch=false
wswitch=false
unset aarg
while getopts ":hasw" opt; do
  case $opt in
    a) aswitch=true ;;
    s) sswitch=true ;;
    w) wswitch=true ;;
    *) usage ;;
  esac
done
shift $((OPTIND -1))

[ $((aswitch + sswitch + wswitch)) -gt 1 ] && echo "Error: Only one of -a, -s, and -w can be used" && exit 1

outfile=$dest/Screenshot-$(date +"%Y-%m-%d_%H-%M-%S").png

if $aswitch; then
  grim $outfile
elif $sswitch; then
  if [[ $XDG_CURRENT_DESKTOP =~ ^niri ]]; then
    output=$(niri msg -j focused-output | jq -r .name)
  elif [[ $XDG_CURRENT_DESKTOP =~ ^sway ]]; then
    output=$(swaymsg -r -t get_outputs | jq '.[] | select(.active==true) | .name')
  elif [[ $XDG_CURRENT_DESKTOP =~ ^Hyprland ]]; then
    output=$(hyprctl -j monitors | jq '.[] | select(.focused==true) | .name')
  fi
  [ -z "$output" ] && echo "Error: Could not determine current screen name" && exit 1
  grim -o $output $outfile
elif $wswitch; then
  if [[ $XDG_CURRENT_DESKTOP =~ ^niri ]]; then
    niri msg action screenshot-window --write-to-disk true
    exit 1
  elif [[ $XDG_CURRENT_DESKTOP =~ ^sway ]]; then
    geometry=$(swaymsg -r -t get_tree | jq -r 'recurse(.nodes[]?, .floating_nodes[]?) | select(.focused) | "\(.rect.x),\(.rect.y) \(.rect.width)x\(.rect.height)"')
  elif [[ $XDG_CURRENT_DESKTOP =~ ^Hyprland ]]; then
    geometry=$(hyprctl -j activewindow | jq -r '"\(.at[0]),\(.at[1]) \(.size[0])x\(.size[1])"')
  fi
  [ -z "$geometry" ] && echo "Error: Could not determine current window geometry" && exit 1
  grim -g $geometry $outfile
else
  geom=$(slurp)
  [ $? != 0 ] && exit 1
  grim -g "$geom" $outfile
fi

cat $outfile | wl-copy --type image/png
notify-send -a $progname "Screenshot" "Screenshot saved as $outfile and copied to clipboard"

