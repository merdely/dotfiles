#!/usr/bin/env bash

maxcount=300
declare -A cameras

reduce_latency="--profile=low-latency --no-cache --untimed"
disable_mpris="--load-scripts=no"

[ -r $XDG_CONFIG_HOME/fuzzy-chooser.conf ] && source $XDG_CONFIG_HOME/fuzzy-chooser.conf
[ -z "$chooser" ] && chooser=$fuzzy_chooser

[ -r $XDG_CONFIG_HOME/cam-chooser.conf ] && source $XDG_CONFIG_HOME/cam-chooser.conf
if [ ${#cameras[@]} = 0 ]; then
  notify-send -a "wm-cam-chooser" -i dialog-warning "Missing Configuration" "Error: You must defined cameras in $XDG_CONFIG_HOME/cam-chooser.conf"
  echo "Error: You must defined cameras in $XDG_CONFIG_HOME/cam-chooser.conf"
  exit 1
fi

# In cam-chooser, define camera URLs like:
# cameras[CAMERANAME]="rtsp://USERNAME:PASSWORD@CAMERA.erdely.in:554"

uri="cam/realmonitor?channel=1"

declare -A subtypes
subtypes[main]=0
subtypes[small]=1
subtypes[medium]=2

[ -r $XDG_CONFIG_HOME/cam-chooser.conf ] && source $XDG_CONFIG_HOME/cam-chooser.conf

testmode=false
stackmode=false
while getopts ":hfrst" opt; do
  case $opt in
    f) chooser=fuzzel ;;
    r) chooser=rofi ;;
    s) stackmode=true ;;
    t) testmode=true ;;
    *)
      echo "usage: $(basename $0) [-h] [-f|-r] [-s]"
      echo "          -h     : show this help text"
      echo "          -f     : use fuzzel"
      echo "          -r     : use rofi"
      echo "          -s     : stack-in-window (default: each camera in own mpv window)"
      exit
      ;;
  esac
done
shift $((OPTIND -1))

if [ -z "$1" ]; then
  camlist="
󰕰  Split View	splitview
󰕰  Front View	frontview
󰕰  Back View	backview
󰞮  Garage Camera	garagecam
󰞮  Backyard Camera	backyardcam
󰞮  Backyard Camera 2	backyardcam2
󰞮  Front Door Camera	frontdoorcam
󰞮  Front Door Camera 2	frontdoorcam2
󰞮  Shed Camera	shedcam
󰞮  Chimney Camera	chimneycam
󰞮  Garage Door Camera	garagedoorcam
  Close Camera Window	quit"
camlist=${camlist:1}

  pgrep -u $LOGNAME -f -- "([r]ofi|[f]uzzel) -p View Camera ?>? ? -d(menu)?" && \
    pkill -u $LOGNAME -f -- "([r]ofi|[f]uzzel) -p View Camera ?>? ? -d(menu)?" || \
      choice=$(
        if [ $chooser = fuzzel ]; then
          echo "$camlist" | fuzzel -p "View Camera > " -d --with-nth=1 --accept-nth=2 --cache=$HOME/.cache/fuzzel_cams
        else
          echo "$camlist" | rofi -p "View Camera" -dmenu -i -display-columns 1 -display-column-separator '\t' -cache-dir $HOME/.cache/rofi_cams
        fi
      )

  [ -z "$choice" -o "$choice" = -1 ] && exit 0

  if [ $chooser = fuzzel ]; then
    cam=$choice
  else
    cam=$(echo "$choice" | awk -F'\t' '{print $2}')
  fi

  if $testmode; then
    echo "cam='$cam'"
    exit
  fi
fi

[ -z "$cam" ] && cam=$1

pkill -9 -f "mpv .*--(wayland-app-id|x11-name|title)=mpvcam"
[ "$cam" = quit ] && exit

splittype=medium

multiview=false
case $cam in
  garagedoorcam)
    rtsp_url="${cameras[$cam]}"
    ;;
  *cam|*cam2)
    rtsp_url="${cameras[$cam]}/$uri&subtype=${subtypes[main]}"
    ;;
  multiview|backview)
    echo "loading backview..." > /dev/stderr
    multiview=true
    cam1=shedcam
    cam2=backyardcam
    cam3=chimneycam
    cam4=backyardcam2
    ;;
  frontview)
    echo "loading frontview..." > /dev/stderr
    multiview=true
    cam1=garagecam
    cam2=frontdoorcam2
    cam3=backyardcam
    cam4=frontdoorcam
    ;;
  splitview)
    echo "loading splitview..." > /dev/stderr
    multiview=true
    cam1=garagecam
    cam2=frontdoorcam2
    cam3=backyardcam2
    cam4=backyardcam
    ;;
  *)
    if [[ $1 =~ ^(https?|rtsp):// ]]; then
      rtsp_url=$1
      cam=$1
    else
      cam=garagecam
      rtsp_url="${cameras[$cam]}/$uri&subtype=${subtypes[main]}"
    fi
    ;;
esac

if ! $multiview; then
  DBUS_FATAL_WARNINGS=0 mpv --mute=yes --stop-screensaver=no --wayland-app-id="mpvcam $cam" $reduce_latency $disable_mpris $rtsp_url &
else
  if $stackmode; then
    DBUS_FATAL_WARNINGS=0 mpv --mute=yes --stop-screensaver=no --wayland-app-id="mpvcam $cam" $reduce_latency $disable_mpris "${cameras[$cam1]}/$uri&subtype=${subtypes[$splittype]}" \
      --external-file={"${cameras[$cam2]}/$uri&subtype=${subtypes[$splittype]}","${cameras[$cam3]}/$uri&subtype=${subtypes[$splittype]}","${cameras[$cam4]}/$uri&subtype=${subtypes[$splittype]}"} \
      --lavfi-complex="[vid1][vid2]hstack=[top];[vid3][vid4]hstack=[bottom];[top][bottom]vstack[vo]" &
  else
    DBUS_FATAL_WARNINGS=0 mpv --mute=yes --stop-screensaver=no --wayland-app-id="mpvcammulti $cam1" $reduce_latency $disable_mpris "${cameras[$cam1]}/$uri&subtype=${subtypes[$splittype]}" &
    DBUS_FATAL_WARNINGS=0 mpv --mute=yes --stop-screensaver=no --wayland-app-id="mpvcammulti $cam2" $reduce_latency $disable_mpris "${cameras[$cam2]}/$uri&subtype=${subtypes[$splittype]}" &
    DBUS_FATAL_WARNINGS=0 mpv --mute=yes --stop-screensaver=no --wayland-app-id="mpvcammulti $cam3" $reduce_latency $disable_mpris "${cameras[$cam3]}/$uri&subtype=${subtypes[$splittype]}" &
    DBUS_FATAL_WARNINGS=0 mpv --mute=yes --stop-screensaver=no --wayland-app-id="mpvcammulti $cam4" $reduce_latency $disable_mpris "${cameras[$cam4]}/$uri&subtype=${subtypes[$splittype]}" &
  fi
fi
