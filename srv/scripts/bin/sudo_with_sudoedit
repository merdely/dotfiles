#!/bin/bash

if [ $(basename $0) = mysudo ] && [ "$1" = "-h" ]; then
  echo "usage: $mysudo [-h] ..."
  echo "  The mysudo wrapper intercepts any attempts to run"
  echo "  'sudo vi' and uses 'sudoedit' instead. It tries to"
  echo "  detect when trying to run sudoedit on files in"
  echo "  directories editable by the user, which is not"
  echo "  allowed with sudo"
  exit
fi

if [[ $1 =~ ^(vi|vim|nvim)$ ]]; then
  unset bad good oldcmd
  oldcmd=$1
  shift
  for file in $@; do
    if [ -f "$file" ] && [ -w "$(dirname "$(realpath "$file")")" ]; then
      bad="$bad $file"
    else
      good="$good $file"
    fi
  done
  if [ -n "${good# }" ]; then
    echo "Executing 'sudoedit' instead of 'sudo $oldcmd'"
    exec sudoedit "${good# }"
    [ -n "${bad# }" ] && echo
  fi
  [ -n "${bad# }" ] && echo "Warning: Do not use sudoedit for these files: ${bad# }"
else
  exec sudo "$@"
fi
