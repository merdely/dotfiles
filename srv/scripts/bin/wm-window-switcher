#!/usr/bin/env bash

[ -r $XDG_CONFIG_HOME/fuzzy-chooser.conf ] && source $XDG_CONFIG_HOME/fuzzy-chooser.conf
[ -z "$chooser" ] && chooser=$fuzzy_chooser

while getopts ":hfr" opt; do
  case $opt in
    f) chooser=fuzzel ;;
    r) chooser=rofi ;;
    *)
      echo "usage: $(basename $0) [-h] [-f|-r]"
      echo "          -h     : show this help text"
      echo "          -f     : use fuzzel"
      echo "          -r     : use rofi"
      exit
      ;;
  esac
done
shift $((OPTIND -1))

get_window_list() {
  if [[ "$XDG_CURRENT_DESKTOP" =~ ^niri ]]; then
    niri msg -j windows | jq -r '.[] | "\(.id)\t\(.app_id) - \(.title)"'
  else
    echo "Error: $XDG_CURRENT_DESKTOP is not supported"
    exit 1
  fi
}

focus_window() {
  id=$(cat -)
  [ -z "$id" ] && return
  if [[ "$XDG_CURRENT_DESKTOP" =~ ^niri ]]; then
    niri msg action focus-window --id $id
  else
    echo "Error: $XDG_CURRENT_DESKTOP is not supported"
    exit 1
  fi
}

if [ "$chooser" = fuzzel ]; then
  pgrep -u $LOGNAME -f -- "fuzzel -p Choose Window >  -d" && \
    pkill -u $LOGNAME -f -- "fuzzel -p Choose Window >  -d" || \
    get_window_list | \
      fuzzel -p "Choose Window > " -d --width 50 \
        --with-nth=2 --accept-nth=1 \
        --cache=$HOME/.cache/fuzzel_windows | \
      focus_window
else
  pgrep -u $LOGNAME -f "[r]ofi -show window -display-window Choose Window" && \
    pkill -u $LOGNAME -f "[r]ofi -show window -display-window Choose Window" || \
    rofi -show window -display-window "Choose Window" -cache-dir ~/.cache/rofi_windows
fi
