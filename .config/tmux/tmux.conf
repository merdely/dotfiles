# Try to make tmux work better with ssh-agent
set -g update-environment "DISPLAY SSH_ASKPASS SSH_AGENT_PID SSH_CONNECTION WINDOWID XAUTHORITY"
set-environment -g SSH_AUTH_SOCK $XDG_RUNTIME_DIR/ssh-auth-sock

# Per Yazi Documentation
set -g allow-passthrough on
set -ga update-environment TERM
set -ga update-environment TERM_PROGRAM

# New style
set -g status-position bottom
set -g status-style "bg=black"
set -g status-left-length 100
set -g status-left-style "fg=#{?client_prefix,gray,blue}"
set -g status-left "#h:#S"
set -g status-justify centre
set -g window-status-current-style "fg=gray"
set -g window-status-current-format "#I:#W#{?window_zoomed_flag,+,}"
set -g window-status-style "fg=blue"
set -g window-status-format "#I:#W#{?window_zoomed_flag,+,}#{?window_last_flag,-,}"
set -g status-right-length 100
set -g status-right-style "fg=black"
set -g status-right "#h:#S"
set -g mode-style "fg=white,bg=blue"
set -g menu-selected-style "fg=blue"
set -g message-command-style "fg=blue"
set -g message-style "fg=blue"
set -g pane-border-style "fg=gray"
set -g pane-active-border-style "#{?pane_in_mode,fg=gray,#{?synchronize-panes,fg=red,fg=blue}}"

# For NeoVim
set-option -sg escape-time 300
set-option -g focus-events on

# Make sure we show 256 colors
# set-option -g default-terminal "screen-256color"

# Use system clipboard
set-option -g set-clipboard on
# Some settings
set-option -g history-limit 100000
set-option -g set-titles off
set-option -g mouse on             # Select and paste with alt+select & alt+middle-click
set-option -g -w allow-rename off

# Use vi-keys
set-option -g status-keys vi
set-option -g -w mode-keys vi

# Keep windows that fail open
#set-option -g -w remain-on-exit failed

# C-b,C-M - toggle mouse support
bind-key C-M "set-option -g mouse"

# C-b,C-Return - toggle scratchpad
bind-key Enter if-shell -F '#{==:#{session_name},scratch}' {
  detach-client
} {
  display-popup -E -w 85% -h 85% "tmux new-session -A -s scratch \\; set status off"
}

# C-b,M - toggle monitor activity
bind-key M 'set -w monitor-activity;display "monitor #{?monitor-activity,on,off}"'
# C-b, S - toggle synchronize panes
bind-key S 'set -w synchronize-panes;set -w -F pane-active-border-style "#{?pane_synchronized,fg=red,fg=#3daee9}";display "sync #{?pane_synchronized,on,off}"'

# Default split keys
# bind-key \" split-window -h
# bind-key % split-window

# Use different keys to split a window with a LOCAL pane
bind-key C-s split-window
bind-key C-v split-window -h
bind-key -T root M-+ split-window -h
bind-key -T root M-D split-window -h
bind-key -T root M-_ split-window

# Cycle through panes with vi keys
bind-key C-h select-pane -L
bind-key C-j select-pane -D
bind-key C-k select-pane -U
bind-key C-l select-pane -R
bind-key C-, select-pane -l

bind-key -T root M-left select-pane -L
bind-key -T root M-right select-pane -R
bind-key -T root M-up select-pane -U
bind-key -T root M-down select-pane -D

# Reorder windows when there are gaps
bind-key r run-shell "/srv/scripts/bin/tmux_reorder"

# Remap refresh-client and map reload config
bind-key F5 refresh-client
bind-key C-r source-file ~/.config/tmux/tmux.conf

# Split horizontally for C-b,% (if ssh'd to host, put that host in the split)
if-shell '[ -x /srv/scripts/bin/tmux_winsplit ]' \
  'bind-key % if-shell "/srv/scripts/bin/tmux_winsplit #{window_name}" "run-shell \"tmux split-window -h\"" "run-shell \"tmux split-window -h \\\"ssh #{window_name}\\\"\""' \
  'bind-key % if-shell "echo \" $HOSTNAME me media bash ksh zsh csh sh \" | grep -q \" #{window_name} \"" "run-shell \"tmux split-window -h\"" "run-shell \"tmux split-window -h \\\"ssh #{window_name}\\\"\""'

# Split vertically for C-b," (if ssh'd to host, put that host in the split)
if-shell '[ -x /srv/scripts/bin/tmux_winsplit ]' \
  'bind-key \" if-shell "/srv/scripts/bin/tmux_winsplit #{window_name}" "run-shell \"tmux split-window\"" "run-shell \"tmux split-window \\\"ssh #{window_name}\\\"\""' \
  'bind-key \" if-shell "echo \" $HOSTNAME me media bash ksh zsh csh sh \" | grep -q \" #{window_name} \"" "run-shell \"tmux split-window\"" "run-shell \"tmux split-window \\\"ssh #{window_name}\\\"\""'

## C-b,k for konnect to SSH host in a new window
if-shell '[ -x /srv/scripts/bin/tmux_groupssh ]' \
  'bind-key k command-prompt -p "Host (or list) to ssh to:" "run-shell \"/srv/scripts/bin/tmux_groupssh -h %%\""' \
  'bind-key k command-prompt -p "Host (or list) to ssh to:" "run-shell \"g=\\\$(echo %%|sed \\\"s/,/ /g\\\");c=0;for f in \\\$g; do [ \\\$c = 0 ] && tmux new-window -n \\\$f \\\"ssh \\\$f\\\" || tmux split-window -t:\\\$ \\\"ssh \\\$f\\\"; c=\\\$((c+1));done;tmux select-layout -t:\\\$.0 tiled;tmux set -w -t:\\\$.0 synchronize-panes;tmux set -gw -t:\\\$.0 pane-active-border-style \\\"fg=red\\\";tmux selectp -t:\\\$.0\""'

## C-b,K for konnect (bypassing known_hosts) to SSH host in a new window
if-shell '[ -x /srv/scripts/bin/tmux_groupssh ]' \
  'bind-key K command-prompt -p "Host (or list) to ssh to (no known_hosts):" "run-shell \"/srv/scripts/bin/tmux_groupssh -h -u %%\""' \
  'bind-key K command-prompt -p "Host (or list) to ssh to (no known_hosts):" "run-shell \"g=\\\$(echo %%|sed \\\"s/,/ /g\\\");c=0;for f in \\\$g; do [ \\\$c = 0 ] && tmux new-window -n \\\$f \\\"ssh -o GlobalKnownHostsFile=/dev/null -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no \\\$f\\\" || tmux split-window -t:\\\$ \\\"ssh -o GlobalKnownHostsFile=/dev/null -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no \\\$f\\\"; c=\\\$((c+1));done;tmux select-layout -t:\\\$.0 tiled;tmux set -w -t:\\\$.0 synchronize-panes;tmux set -gw -t:\\\$.0 pane-active-border-style \\\"fg=red\\\";tmux selectp -t:\\\$.0\""'

# C-b,j for join -- split this window and ssh to a specified host
bind-key j command-prompt -p "Host to ssh to (split):" "split-window -h 'ssh %1'"

# C-b,J for join -- split this window vertically and ssh to a specified host
bind-key J command-prompt -p "Host to ssh to (vsplit):" "split-window 'ssh %1'"

# C-b,n for new -- open a new window sshing to same host as current window
bind-key C-n run-shell 'tmux new-window -n "#{window_name}" "ssh #{window_name}"'

# Read any configuration from a local file (like: bind-key c new-window -n "mercury")
if-shell "test -e ~/.config/tmux/tmux.conf.local" "source-file ~/.config/tmux/tmux.conf.local"
