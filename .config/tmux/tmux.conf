# Set numbering at 1 instead of 0
set -g base-index 1

# Try to make tmux work better with ssh-agent
set -g update-environment "DISPLAY SSH_ASKPASS SSH_AGENT_PID SSH_CONNECTION WINDOWID XAUTHORITY"
setenv -g SSH_AUTH_SOCK $XDG_RUNTIME_DIR/ssh-auth-sock

# For troubleshooting
# set -g remain-on-exit failed

# Per Yazi Documentation
set -g allow-passthrough on
set -ga update-environment TERM
set -ga update-environment TERM_PROGRAM

# Set c-a as a second prefix if running tmux in tmux
if '[ -z "#{@nested}" ]' \
    'run "[[ \"$TERM\" =~ tmux ]] && tmux set -g @nested yes || tmux set -g @nested no"'
if '[ "#{@nested}" = yes ]' 'set -g prefix2 C-a'

# Set myname to #{host_short}
run "tmux set -g @myname $(hostname -s)"

set -g allow-rename off
set-hook -g after-new-session 'rename-window "#{@myname}'
bind c neww -n "#{@myname}"

# Color palette
set -g @bg_color "black"
set -g @fg_color "blue"
set -g @alt_fg_color "blue"
set -g @alt_bg_color "#303030"
set -g @highlight_color "gray"
set -g @hl_bright_color "white"
set -g @alert_color "red"
set -g @half_round_open "#(printf '\uE0B6')"
set -g @half_round_close "#(printf '\uE0B4')"

# Command shortcuts
set -g @sshk "ssh -o GlobalKnownHostsFile=/dev/null -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no"

# This isn't working right because it is not changing colors when I use the prefix
# set -g status-left "#[fg=#{@alt_bg_color}]@half_round_open#[fg=#{@alt_fg_color},bg=#{@alt_bg_color}]#{@myname}:#S#[fg=#{@alt_bg_color},bg=#{@bg_color}]@half_round_close"

# New style
set -g status-position bottom
set -g status-style "bg=#{@bg_color}"
set -g status-left-length 100
set -g status-left-style "fg=#{?client_prefix,#{@highlight_color},#{@fg_color}}"
set -g status-left "#{@myname}:#S"
if '[ "#{@nested}" = yes ]' 'set -g status-left "#{@myname}:#S#[fg=#{@bg_color}] prefix:a"'
set -g status-justify centre
set -g window-status-current-style "fg=#{@highlight_color}"
set -g window-status-current-format "#I:#W#{?window_zoomed_flag,+,}"
set -g window-status-style "fg=#{@fg_color}"
set -g window-status-format "#I:#W#{?window_zoomed_flag,+,}#{?window_last_flag,-,}"
set -g status-right-length 100
set -g status-right-style "fg=#{@bg_color}"
set -g status-right "#{@myname}:#S"
if '[ "#{@nested}" = yes ]' 'set -g status-right "#{@myname}:#S#[fg=#{@fg_color}] prefix: a"'
set -g mode-style "fg=#{@hl_bright_color},bg=#{@fg_color}"
set -g menu-selected-style "fg=#{@fg_color}"
set -g message-command-style "fg=#{@fg_color}"
# set -g message-style "fg=#{@highlight_color}"
set -g message-style "fg=#{@highlight_color}"
set -g pane-border-style "fg=#{@highlight_color}"
set -g pane-active-border-style "#{?pane_in_mode,fg=#{@highlight_color},#{?synchronize-panes,fg=#{@alert_color},fg=#{@fg_color}}}"

# For NeoVim
set -sg escape-time 300
set -g focus-events on

# Make sure we show 256 colors
# set -g default-terminal "screen-256color"

# Use system clipboard
set -g set-clipboard on
# Some settings
set -g history-limit 100000
set -g set-titles off
set -g mouse on             # Select and paste with alt+select & alt+middle-click
set -g -w allow-rename off

# Use vi-keys
set -g status-keys vi
set -g -w mode-keys vi

# C-b,C-M - toggle mouse support
bind C-M "set -g mouse"

# C-b,C-Return - toggle scratchpad
bind Enter if -F '#{==:#{session_name},scratch}' {
  detach-client
} {
  display-popup -E -w 85% -h 85% "tmux new-session -A -s scratch \\; set status off"
}

# C-b,M - toggle monitor activity
bind M 'set -w monitor-activity;display "monitor #{?monitor-activity,on,off}"'
# C-b, S - toggle synchronize panes
bind S 'set -w synchronize-panes;set -w -F pane-active-border-style "#{?pane_synchronized,fg=#{@alert_color},fg=#3daee9}";display "sync #{?pane_synchronized,on,off}"'

# Default split keys
# bind \" splitw -h
# bind % splitw

# Use different keys to split a window with a LOCAL pane
bind C-s splitw -h
bind C-v splitw -v
bind -T root M-+ splitw -h
bind -T root M-D splitw -h
bind -T root M-_ splitw -v

bind -T prefix 0 select-window -t :=1
#bind -T root M-0 select-window -t :=1
#bind -T root M-1 select-window -t :=1
#bind -T root M-2 select-window -t :=2
#bind -T root M-3 select-window -t :=3
#bind -T root M-4 select-window -t :=4
#bind -T root M-5 select-window -t :=5
#bind -T root M-6 select-window -t :=6
#bind -T root M-7 select-window -t :=7
#bind -T root M-8 select-window -t :=8
#bind -T root M-9 select-window -t :=9
#bind -T root M-) select-window -t :=10
#bind -T root M-! select-window -t :=11
#bind -T root M-@ select-window -t :=12
#bind -T root M-# select-window -t :=13
#bind -T root M-$ select-window -t :=14
#bind -T root M-% select-window -t :=15
#bind -T root M-^ select-window -t :=16
#bind -T root M-& select-window -t :=17
#bind -T root M-* select-window -t :=18
#bind -T root M-( select-window -t :=19

# Override some keybindings
bind    -T prefix       0                         select-window -t :=1
bind    -T prefix       !                         select-window -t :=11
bind    -T prefix       @                         select-window -t :=12
bind    -T prefix       \#                        select-window -t :=13
bind    -T prefix       \$                        select-window -t :=14
#bind    -T prefix       \%                        select-window -t :=15  # Cannot be enabled at the same time as binding for splits (default behavior)
bind    -T prefix       ^                         select-window -t :=16
bind    -T prefix       &                         select-window -t :=17
bind    -T prefix       *                         select-window -t :=18
bind    -T prefix       (                         select-window -t :=19
bind    -T prefix       )                         select-window -t :=10

bind    -T prefix       B                         break-pane
bind    -T prefix       Y                         list-buffers
bind    -T prefix       R                         command-prompt -I "#S" -p "#[fg=#{@fg_color}]rename-session>" { rename-session "%%" }
bind    -T prefix       X                         confirm-before -p "kill-window #W? (y/n)" kill-window
bind    -T prefix       O                         switch-client -p
bind    -T prefix       P                         switch-client -n
bind    -T prefix       DC                        delete-buffer

# Cycle through panes with vi keys
bind C-h select-pane -L
bind C-j select-pane -D
bind C-k select-pane -U
bind C-l select-pane -R
bind C-, select-pane -l

bind -T root M-left select-pane -L
bind -T root M-right select-pane -R
bind -T root M-up select-pane -U
bind -T root M-down select-pane -D

# Reorder windows when there are gaps
bind r run "tmux_reorder"

# Remap refresh-client and map reload config
bind F5 refresh-client
bind C-r source-file ~/.config/tmux/tmux.conf

# Change prompt styling
bind "'" command-prompt -T window-target -p "#[fg=#{@fg_color}]select-window (current: #I)>" { select-window -t ":%%" }
bind , command-prompt -p "#[fg=#{@fg_color}]rename-window>" -I "#W" { rename-window "%%" }
bind . command-prompt -p "#[fg=#{@fg_color}]move-window>" -T target { move-window -t "%%" }
bind / command-prompt -k -p "#[fg=#{@fg_color}]key>" { list-keys -1N "%%" }
bind : command-prompt -p "#[fg=#{@fg_color}]tmux>"
bind f command-prompt -p "#[fg=#{@fg_color}]find-window>" { find-window -Z "%%" }

# Change copy mode styling
bind -T copy-mode F command-prompt -1 -p "#[fg=#{@fg_color}]jump backward>" { send-keys -X jump-backward "%%" }
bind -T copy-mode T command-prompt -1 -p "#[fg=#{@fg_color}]jump to backward>" { send-keys -X jump-to-backward "%%" }
bind -T copy-mode f command-prompt -1 -p "#[fg=#{@fg_color}]jump forward>" { send-keys -X jump-forward "%%" }
bind -T copy-mode g command-prompt -p "#[fg=#{@fg_color}]goto line>" { send-keys -X goto-line "%%" }
bind -T copy-mode t command-prompt -1 -p "#[fg=#{@fg_color}]jump to forward>" { send-keys -X jump-to-forward "%%" }
bind -T copy-mode M-1 command-prompt -N -I 1 -p "#[fg=#{@fg_color}]repeat>" { send-keys -N "%%" }
bind -T copy-mode M-2 command-prompt -N -I 2 -p "#[fg=#{@fg_color}]repeat>" { send-keys -N "%%" }
bind -T copy-mode M-3 command-prompt -N -I 3 -p "#[fg=#{@fg_color}]repeat>" { send-keys -N "%%" }
bind -T copy-mode M-4 command-prompt -N -I 4 -p "#[fg=#{@fg_color}]repeat>" { send-keys -N "%%" }
bind -T copy-mode M-5 command-prompt -N -I 5 -p "#[fg=#{@fg_color}]repeat>" { send-keys -N "%%" }
bind -T copy-mode M-6 command-prompt -N -I 6 -p "#[fg=#{@fg_color}]repeat>" { send-keys -N "%%" }
bind -T copy-mode M-7 command-prompt -N -I 7 -p "#[fg=#{@fg_color}]repeat>" { send-keys -N "%%" }
bind -T copy-mode M-8 command-prompt -N -I 8 -p "#[fg=#{@fg_color}]repeat>" { send-keys -N "%%" }
bind -T copy-mode M-9 command-prompt -N -I 9 -p "#[fg=#{@fg_color}]repeat>" { send-keys -N "%%" }
bind -T copy-mode C-r command-prompt -i -I "#{pane_search_string}" -T search -p "#[fg=#{@fg_color}]search up>" { send-keys -X search-backward-incremental "%%" }
bind -T copy-mode C-s command-prompt -i -I "#{pane_search_string}" -T search -p "#[fg=#{@fg_color}]search down>" { send-keys -X search-forward-incremental "%%" }
bind -T copy-mode-vi / command-prompt -T search -p "#[fg=#{@fg_color}]search down>" { send-keys -X search-forward "%%" }
bind -T copy-mode-vi 1 command-prompt -N -I 1 -p "#[fg=#{@fg_color}]repeat>" { send-keys -N "%%" }
bind -T copy-mode-vi 2 command-prompt -N -I 2 -p "#[fg=#{@fg_color}]repeat>" { send-keys -N "%%" }
bind -T copy-mode-vi 3 command-prompt -N -I 3 -p "#[fg=#{@fg_color}]repeat>" { send-keys -N "%%" }
bind -T copy-mode-vi 4 command-prompt -N -I 4 -p "#[fg=#{@fg_color}]repeat>" { send-keys -N "%%" }
bind -T copy-mode-vi 5 command-prompt -N -I 5 -p "#[fg=#{@fg_color}]repeat>" { send-keys -N "%%" }
bind -T copy-mode-vi 6 command-prompt -N -I 6 -p "#[fg=#{@fg_color}]repeat>" { send-keys -N "%%" }
bind -T copy-mode-vi 7 command-prompt -N -I 7 -p "#[fg=#{@fg_color}]repeat>" { send-keys -N "%%" }
bind -T copy-mode-vi 8 command-prompt -N -I 8 -p "#[fg=#{@fg_color}]repeat>" { send-keys -N "%%" }
bind -T copy-mode-vi 9 command-prompt -N -I 9 -p "#[fg=#{@fg_color}]repeat>" { send-keys -N "%%" }
bind -T copy-mode-vi : command-prompt -p "#[fg=#{@fg_color}]goto line>" { send-keys -X goto-line "%%" }
bind -T copy-mode-vi ? command-prompt -T search -p "#[fg=#{@fg_color}]search up>" { send-keys -X search-backward "%%" }
bind -T copy-mode-vi F command-prompt -1 -p "#[fg=#{@fg_color}]jump backward>" { send-keys -X jump-backward "%%" }
bind -T copy-mode-vi T command-prompt -1 -p "#[fg=#{@fg_color}]jump to backward>" { send-keys -X jump-to-backward "%%" }
bind -T copy-mode-vi f command-prompt -1 -p "#[fg=#{@fg_color}]jump forward>" { send-keys -X jump-forward "%%" }
bind -T copy-mode-vi t command-prompt -1 -p "#[fg=#{@fg_color}]jump to forward>" { send-keys -X jump-to-forward "%%" }

# Split horizontally for %,C-%,C-\,\,| (if ssh'd to host, put that host in the split)
# Split vertically   for ",C--,-,C-_,_ (if ssh'd to host, put that host in the split)
# C-b,n for new window sshing to same host as current window
if 'which tmux_winsplit' {
  bind C-%  if "tmux_winsplit #{window_name}" "splitw -h" "run 'tmux splitw -h ssh #{window_name}'"
  # 'bind %' cannot be enabled at the same time as binding for accessing window 15
  bind %    if "tmux_winsplit #{window_name}" "splitw -h" "run 'tmux splitw -h ssh #{window_name}'"
  bind C-\\ if "tmux_winsplit #{window_name}" "splitw -h" "run 'tmux splitw -h ssh #{window_name}'"
  bind \\   if "tmux_winsplit #{window_name}" "splitw -h" "run 'tmux splitw -h ssh #{window_name}'"
  bind |    if "tmux_winsplit #{window_name}" "splitw -h" "run 'tmux splitw -h ssh #{window_name}'"
  bind \"   if "tmux_winsplit #{window_name}" "splitw -v" "run 'tmux splitw -v ssh #{window_name}'"
  bind C--  if "tmux_winsplit #{window_name}" "splitw -v" "run 'tmux splitw -v ssh #{window_name}'"
  bind -    if "tmux_winsplit #{window_name}" "splitw -v" "run 'tmux splitw -v ssh #{window_name}'"
  bind C-_  if "tmux_winsplit #{window_name}" "splitw -v" "run 'tmux splitw -v ssh #{window_name}'"
  bind _    if "tmux_winsplit #{window_name}" "splitw -v" "run 'tmux splitw -v ssh #{window_name}'"
  bind C-n  if "tmux_winsplit #{window_name}" "run 'tmux neww -n #{@myname}'" "run 'tmux neww -n #{window_name} ssh #{window_name}'"
} {
  bind C-%  if "echo ' $HOSTNAME me home PIs bash ksh zsh csh sh '|grep -q ' #{window_name} '" "splitw -h" "run 'tmux splitw -h ssh #{window_name}'"
  bind %    if "echo ' $HOSTNAME me home PIs bash ksh zsh csh sh '|grep -q ' #{window_name} '" "splitw -h" "run 'tmux splitw -h ssh #{window_name}'"
  bind C-\\ if "echo ' $HOSTNAME me home PIs bash ksh zsh csh sh '|grep -q ' #{window_name} '" "splitw -h" "run 'tmux splitw -h ssh #{window_name}'"
  bind \\   if "echo ' $HOSTNAME me home PIs bash ksh zsh csh sh '|grep -q ' #{window_name} '" "splitw -h" "run 'tmux splitw -h ssh #{window_name}'"
  bind |    if "echo ' $HOSTNAME me home PIs bash ksh zsh csh sh '|grep -q ' #{window_name} '" "splitw -h" "run 'tmux splitw -h ssh #{window_name}'"
  bind \"   if "echo ' $HOSTNAME me home PIs bash ksh zsh csh sh '|grep -q ' #{window_name} '" "splitw -v" "run 'tmux splitw -v ssh #{window_name}'"
  bind C--  if "echo ' $HOSTNAME me home PIs bash ksh zsh csh sh '|grep -q ' #{window_name} '" "splitw -v" "run 'tmux splitw -v ssh #{window_name}'"
  bind -    if "echo ' $HOSTNAME me home PIs bash ksh zsh csh sh '|grep -q ' #{window_name} '" "splitw -v" "run 'tmux splitw -v ssh #{window_name}'"
  bind C-_  if "echo ' $HOSTNAME me home PIs bash ksh zsh csh sh '|grep -q ' #{window_name} '" "splitw -v" "run 'tmux splitw -v ssh #{window_name}'"
  bind _    if "echo ' $HOSTNAME me home PIs bash ksh zsh csh sh '|grep -q ' #{window_name} '" "splitw -v" "run 'tmux splitw -v ssh #{window_name}'"
  bind C-n  if "echo ' $HOSTNAME home me PIs bash ksh zsh csh sh '|grep -q ' #{window_name} '" "neww -n #{window_name}" "run 'tmux neww -n #{window_name} ssh #{window_name}'"
}

## C-b,k for konnect to SSH host in a new window
## C-b,K for konnect (bypassing known_hosts) to SSH host in a new window
## C-b,g for go to SSH host via ipv4 in a new window
## C-b,G for go (bypassing known_hosts) via ipv4 to SSH host in a new window
if 'which tmux_groupssh' {
  bind k command-prompt -p "#[fg=#{@fg_color}]Host/list to ssh to:" "run 'tmux_groupssh -h %%'"
  bind K command-prompt -p "#[fg=#{@fg_color}]Host/list to ssh to (no known_hosts):" "run 'tmux_groupssh -u -h %%'"
  bind g command-prompt -p "#[fg=#{@fg_color}]Host/list to ssh (ipv4) to:" "run 'tmux_groupssh -4 -h %%'"
  bind G command-prompt -p "#[fg=#{@fg_color}]Host/list to ssh (ipv4) to (no known_hosts):" "run 'tmux_groupssh -u -4 -h %%'"
} {
  bind k command-prompt -p "#[fg=#{@fg_color}]Host/List to ssh to:" "run 'g=\$(echo %1|sed \"s/,/ /g\");c=0;for f in \$g;do [ \$c = 0 ]&&tmux neww -n \$f ssh \$f||tmux splitw -t:\$ ssh \$f;c=\$((c+1));done;tmux selectl -t:\$.0 tiled;tmux selectp -t \$.0"
  bind K command-prompt -p "#[fg=#{@fg_color}]Host/List to ssh to (no known_hosts):" "run 'g=\$(echo %1|sed \"s/,/ /g\");c=0;for f in \$g;do [ \$c = 0 ]&&tmux neww -n \$f #{@sshk} \$f||tmux splitw -t:\$ #{@sshk} \$f;c=\$((c+1));done;tmux selectl -t:\$.0 tiled;tmux selectp -t \$.0"
  bind g command-prompt -p "#[fg=#{@fg_color}]Host/List to ssh (ipv4) to:" "run 'g=\$(echo %1|sed \"s/,/ /g\");c=0;for f in \$g;do [ \$c = 0 ]&&tmux neww -n \$f ssh -4 \$f||tmux splitw -t:\$ ssh -4 \$f;c=\$((c+1));done;tmux selectl -t:\$.0 tiled;tmux selectp -t \$.0"
  bind G command-prompt -p "#[fg=#{@fg_color}]Host/List to ssh (ipv4) to (no known_hosts):" "run 'g=\$(echo %1|sed \"s/,/ /g\");c=0;for f in \$g;do [ \$c = 0 ]&&tmux neww -n \$f #{@sshk} -4 \$f||tmux splitw -t:\$ #{@sshk} -4 \$f;c=\$((c+1));done;tmux selectl -t:\$.0 tiled;tmux selectp -t \$.0"
}

# C-b,j for join -- split this window and ssh to a specified host
bind j command-prompt -p "#[fg=#{@fg_color}]Host to ssh to (split):" "splitw -h ssh %1"

# C-b,J for join -- split this window vertically and ssh to a specified host
bind J command-prompt -p "#[fg=#{@fg_color}]Host to ssh to (vsplit):" "splitw ssh %1"

# C-b,h for half-join -- split this window and ssh via ipv4 to a specified host
bind h command-prompt -p "#[fg=#{@fg_color}]Host to ssh (ipv4) to (split):" "splitw -h ssh -4 %1"

# C-b,H for half-join -- split this window vertically and ssh via ipv4 to a specified host
bind H command-prompt -p "#[fg=#{@fg_color}]Host to ssh (ipv4) to (vsplit):" "splitw ssh -4 %1"

# Read any configuration from a local file (like: bind c neww -n "mercury")
if "test -e ~/.config/tmux/tmux.conf.local" "source-file ~/.config/tmux/tmux.conf.local"

