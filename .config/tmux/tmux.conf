# Set numbering at 1 instead of 0
set -g base-index 1

# Try to make tmux work better with ssh-agent
set -g update-environment "DISPLAY SSH_ASKPASS SSH_AGENT_PID SSH_CONNECTION WINDOWID XAUTHORITY"
set-environment -g SSH_AUTH_SOCK $XDG_RUNTIME_DIR/ssh-auth-sock

# Per Yazi Documentation
set -g allow-passthrough on
set -ga update-environment TERM
set -ga update-environment TERM_PROGRAM

# Set c-a as a second prefix if running tmux in tmux
if-shell '[ -z "#{@nested}" ]' \
    'run-shell "[[ \"$TERM\" =~ tmux ]] && tmux set -g @nested yes || tmux set -g @nested no"'
if-shell '[ "#{@nested}" = "yes" ]' 'set -g prefix2 C-a'

set -g allow-rename off
set-hook -g after-new-session 'rename-window "#h"'
bind-key c new-window -n "#h"

# Color palette
set-option -g @bg_color "black"
set-option -g @fg_color "blue"
set-option -g @alt_fg_color "blue"
set-option -g @alt_bg_color "#303030"
set-option -g @highlight_color "gray"
set-option -g @hl_bright_color "white"
set-option -g @alert_color "red"
set-option -g @half_round_open "#(printf '\uE0B6')"
set-option -g @half_round_close "#(printf '\uE0B4')"

# This isn't working right because it is not changing colors when I use the prefix
# set -g status-left "#[fg=#{@alt_bg_color}]@half_round_open#[fg=#{@alt_fg_color},bg=#{@alt_bg_color}]#h:#S#[fg=#{@alt_bg_color},bg=#{@bg_color}]@half_round_close"

# New style
set -g status-position bottom
set -g status-style "bg=#{@bg_color}"
set -g status-left-length 100
set -g status-left-style "fg=#{?client_prefix,#{@highlight_color},#{@fg_color}}"
set -g status-left "#h:#S"
if-shell '[ "#{@nested}" = "yes" ]' 'set -g status-left "#h:#S#[fg=#{@bg_color}] prefix:a"'
set -g status-justify centre
set -g window-status-current-style "fg=#{@highlight_color}"
set -g window-status-current-format "#I:#W#{?window_zoomed_flag,+,}"
set -g window-status-style "fg=#{@fg_color}"
set -g window-status-format "#I:#W#{?window_zoomed_flag,+,}#{?window_last_flag,-,}"
set -g status-right-length 100
set -g status-right-style "fg=#{@bg_color}"
set -g status-right "#h:#S"
if-shell '[ "#{@nested}" = "yes" ]' 'set -g status-right "#h:#S#[fg=#{@fg_color}] prefix: a"'
set -g mode-style "fg=#{@hl_bright_color},bg=#{@fg_color}"
set -g menu-selected-style "fg=#{@fg_color}"
set -g message-command-style "fg=#{@fg_color}"
# set -g message-style "fg=#{@highlight_color}"
set -g message-style "fg=#{@highlight_color}"
set -g pane-border-style "fg=#{@highlight_color}"
set -g pane-active-border-style "#{?pane_in_mode,fg=#{@highlight_color},#{?synchronize-panes,fg=#{@alert_color},fg=#{@fg_color}}}"

# For NeoVim
set-option -sg escape-time 300
set-option -g focus-events on

# Make sure we show 256 colors
# set-option -g default-terminal "screen-256color"

# Use system clipboard
set-option -g set-clipboard on
# Some settings
set-option -g history-limit 100000
set-option -g set-titles off
set-option -g mouse on             # Select and paste with alt+select & alt+middle-click
set-option -g -w allow-rename off

# Use vi-keys
set-option -g status-keys vi
set-option -g -w mode-keys vi

# Keep windows that fail open
#set-option -g -w remain-on-exit failed

# C-b,C-M - toggle mouse support
bind-key C-M "set-option -g mouse"

# C-b,C-Return - toggle scratchpad
bind-key Enter if-shell -F '#{==:#{session_name},scratch}' {
  detach-client
} {
  display-popup -E -w 85% -h 85% "tmux new-session -A -s scratch \\; set status off"
}

# C-b,M - toggle monitor activity
bind-key M 'set -w monitor-activity;display "monitor #{?monitor-activity,on,off}"'
# C-b, S - toggle synchronize panes
bind-key S 'set -w synchronize-panes;set -w -F pane-active-border-style "#{?pane_synchronized,fg=#{@alert_color},fg=#3daee9}";display "sync #{?pane_synchronized,on,off}"'

# Default split keys
# bind-key \" split-window -h
# bind-key % split-window

# Use different keys to split a window with a LOCAL pane
bind-key C-s split-window -h
bind-key C-v split-window -v
bind-key -T root M-+ split-window -h
bind-key -T root M-D split-window -h
bind-key -T root M-_ split-window -v

bind-key -T prefix 0 select-window -t :=1
#bind-key -T root M-0 select-window -t :=1
#bind-key -T root M-1 select-window -t :=1
#bind-key -T root M-2 select-window -t :=2
#bind-key -T root M-3 select-window -t :=3
#bind-key -T root M-4 select-window -t :=4
#bind-key -T root M-5 select-window -t :=5
#bind-key -T root M-6 select-window -t :=6
#bind-key -T root M-7 select-window -t :=7
#bind-key -T root M-8 select-window -t :=8
#bind-key -T root M-9 select-window -t :=9
#bind-key -T root M-) select-window -t :=10
#bind-key -T root M-! select-window -t :=11
#bind-key -T root M-@ select-window -t :=12
#bind-key -T root M-# select-window -t :=13
#bind-key -T root M-$ select-window -t :=14
#bind-key -T root M-% select-window -t :=15
#bind-key -T root M-^ select-window -t :=16
#bind-key -T root M-& select-window -t :=17
#bind-key -T root M-* select-window -t :=18
#bind-key -T root M-( select-window -t :=19

# Override some keybindings
bind-key    -T prefix       0                         select-window -t :=1
bind-key    -T prefix       !                         select-window -t :=11
bind-key    -T prefix       @                         select-window -t :=12
bind-key    -T prefix       \#                        select-window -t :=13
bind-key    -T prefix       \$                        select-window -t :=14
#bind-key    -T prefix       \%                        select-window -t :=15
bind-key    -T prefix       ^                         select-window -t :=16
bind-key    -T prefix       &                         select-window -t :=17
bind-key    -T prefix       *                         select-window -t :=18
bind-key    -T prefix       (                         select-window -t :=19
bind-key    -T prefix       )                         select-window -t :=10

bind-key    -T prefix       B                         break-pane
bind-key    -T prefix       Y                         list-buffers
bind-key    -T prefix       R                         command-prompt -I "#S" -p "#[fg=#{@fg_color}]rename-session>" { rename-session "%%" }
bind-key    -T prefix       X                         confirm-before -p "kill-window #W? (y/n)" kill-window
bind-key    -T prefix       O                         switch-client -p
bind-key    -T prefix       P                         switch-client -n
bind-key    -T prefix       DC                        delete-buffer

# Cycle through panes with vi keys
bind-key C-h select-pane -L
bind-key C-j select-pane -D
bind-key C-k select-pane -U
bind-key C-l select-pane -R
bind-key C-, select-pane -l

bind-key -T root M-left select-pane -L
bind-key -T root M-right select-pane -R
bind-key -T root M-up select-pane -U
bind-key -T root M-down select-pane -D

# Reorder windows when there are gaps
bind-key r run-shell "tmux_reorder"

# Remap refresh-client and map reload config
bind-key F5 refresh-client
bind-key C-r source-file ~/.config/tmux/tmux.conf

# Change prompt styling
bind-key "'" command-prompt -T window-target -p "#[fg=#{@fg_color}]select-window (current: #I)>" { select-window -t ":%%" }
bind-key , command-prompt -p "#[fg=#{@fg_color}]rename-window>" -I "#W" { rename-window "%%" }
bind-key . command-prompt -p "#[fg=#{@fg_color}]move-window>" -T target { move-window -t "%%" }
bind-key / command-prompt -k -p "#[fg=#{@fg_color}]key>" { list-keys -1N "%%" }
bind-key : command-prompt -p "#[fg=#{@fg_color}]tmux>"
bind-key f command-prompt -p "#[fg=#{@fg_color}]find-window>" { find-window -Z "%%" }

# Change copy mode styling
bind-key -T copy-mode F command-prompt -1 -p "#[fg=#{@fg_color}]jump backward>" { send-keys -X jump-backward "%%" }
bind-key -T copy-mode T command-prompt -1 -p "#[fg=#{@fg_color}]jump to backward>" { send-keys -X jump-to-backward "%%" }
bind-key -T copy-mode f command-prompt -1 -p "#[fg=#{@fg_color}]jump forward>" { send-keys -X jump-forward "%%" }
bind-key -T copy-mode g command-prompt -p "#[fg=#{@fg_color}]goto line>" { send-keys -X goto-line "%%" }
bind-key -T copy-mode t command-prompt -1 -p "#[fg=#{@fg_color}]jump to forward>" { send-keys -X jump-to-forward "%%" }
bind-key -T copy-mode M-1 command-prompt -N -I 1 -p "#[fg=#{@fg_color}]repeat>" { send-keys -N "%%" }
bind-key -T copy-mode M-2 command-prompt -N -I 2 -p "#[fg=#{@fg_color}]repeat>" { send-keys -N "%%" }
bind-key -T copy-mode M-3 command-prompt -N -I 3 -p "#[fg=#{@fg_color}]repeat>" { send-keys -N "%%" }
bind-key -T copy-mode M-4 command-prompt -N -I 4 -p "#[fg=#{@fg_color}]repeat>" { send-keys -N "%%" }
bind-key -T copy-mode M-5 command-prompt -N -I 5 -p "#[fg=#{@fg_color}]repeat>" { send-keys -N "%%" }
bind-key -T copy-mode M-6 command-prompt -N -I 6 -p "#[fg=#{@fg_color}]repeat>" { send-keys -N "%%" }
bind-key -T copy-mode M-7 command-prompt -N -I 7 -p "#[fg=#{@fg_color}]repeat>" { send-keys -N "%%" }
bind-key -T copy-mode M-8 command-prompt -N -I 8 -p "#[fg=#{@fg_color}]repeat>" { send-keys -N "%%" }
bind-key -T copy-mode M-9 command-prompt -N -I 9 -p "#[fg=#{@fg_color}]repeat>" { send-keys -N "%%" }
bind-key -T copy-mode C-r command-prompt -i -I "#{pane_search_string}" -T search -p "#[fg=#{@fg_color}]search up>" { send-keys -X search-backward-incremental "%%" }
bind-key -T copy-mode C-s command-prompt -i -I "#{pane_search_string}" -T search -p "#[fg=#{@fg_color}]search down>" { send-keys -X search-forward-incremental "%%" }
bind-key -T copy-mode-vi / command-prompt -T search -p "#[fg=#{@fg_color}]search down>" { send-keys -X search-forward "%%" }
bind-key -T copy-mode-vi 1 command-prompt -N -I 1 -p "#[fg=#{@fg_color}]repeat>" { send-keys -N "%%" }
bind-key -T copy-mode-vi 2 command-prompt -N -I 2 -p "#[fg=#{@fg_color}]repeat>" { send-keys -N "%%" }
bind-key -T copy-mode-vi 3 command-prompt -N -I 3 -p "#[fg=#{@fg_color}]repeat>" { send-keys -N "%%" }
bind-key -T copy-mode-vi 4 command-prompt -N -I 4 -p "#[fg=#{@fg_color}]repeat>" { send-keys -N "%%" }
bind-key -T copy-mode-vi 5 command-prompt -N -I 5 -p "#[fg=#{@fg_color}]repeat>" { send-keys -N "%%" }
bind-key -T copy-mode-vi 6 command-prompt -N -I 6 -p "#[fg=#{@fg_color}]repeat>" { send-keys -N "%%" }
bind-key -T copy-mode-vi 7 command-prompt -N -I 7 -p "#[fg=#{@fg_color}]repeat>" { send-keys -N "%%" }
bind-key -T copy-mode-vi 8 command-prompt -N -I 8 -p "#[fg=#{@fg_color}]repeat>" { send-keys -N "%%" }
bind-key -T copy-mode-vi 9 command-prompt -N -I 9 -p "#[fg=#{@fg_color}]repeat>" { send-keys -N "%%" }
bind-key -T copy-mode-vi : command-prompt -p "#[fg=#{@fg_color}]goto line>" { send-keys -X goto-line "%%" }
bind-key -T copy-mode-vi ? command-prompt -T search -p "#[fg=#{@fg_color}]search up>" { send-keys -X search-backward "%%" }
bind-key -T copy-mode-vi F command-prompt -1 -p "#[fg=#{@fg_color}]jump backward>" { send-keys -X jump-backward "%%" }
bind-key -T copy-mode-vi T command-prompt -1 -p "#[fg=#{@fg_color}]jump to backward>" { send-keys -X jump-to-backward "%%" }
bind-key -T copy-mode-vi f command-prompt -1 -p "#[fg=#{@fg_color}]jump forward>" { send-keys -X jump-forward "%%" }
bind-key -T copy-mode-vi t command-prompt -1 -p "#[fg=#{@fg_color}]jump to forward>" { send-keys -X jump-to-forward "%%" }

# Split horizontally for C-b,% (if ssh'd to host, put that host in the split)
if-shell 'which tmux_winsplit' \
  'bind-key % if-shell "tmux_winsplit #{window_name}" "run-shell \"tmux split-window -h\"" "run-shell \"tmux split-window -h \\\"ssh #{window_name}\\\"\""' \
  'bind-key % if-shell "echo \" $HOSTNAME me media bash ksh zsh csh sh \" | grep -q \" #{window_name} \"" "run-shell \"tmux split-window -h\"" "run-shell \"tmux split-window -h \\\"ssh #{window_name}\\\"\""'
if-shell 'which tmux_winsplit' \
  'bind-key C-\\ if-shell "tmux_winsplit #{window_name}" "run-shell \"tmux split-window -h\"" "run-shell \"tmux split-window -h \\\"ssh #{window_name}\\\"\""' \
  'bind-key C-\\ if-shell "echo \" $HOSTNAME me media bash ksh zsh csh sh \" | grep -q \" #{window_name} \"" "run-shell \"tmux split-window -h\"" "run-shell \"tmux split-window -h \\\"ssh #{window_name}\\\"\""'
if-shell 'which tmux_winsplit' \
  'bind-key \\ if-shell "tmux_winsplit #{window_name}" "run-shell \"tmux split-window -h\"" "run-shell \"tmux split-window -h \\\"ssh #{window_name}\\\"\""' \
  'bind-key \\ if-shell "echo \" $HOSTNAME me media bash ksh zsh csh sh \" | grep -q \" #{window_name} \"" "run-shell \"tmux split-window -h\"" "run-shell \"tmux split-window -h \\\"ssh #{window_name}\\\"\""'
if-shell 'which tmux_winsplit' \
  'bind-key | if-shell "tmux_winsplit #{window_name}" "run-shell \"tmux split-window -h\"" "run-shell \"tmux split-window -h \\\"ssh #{window_name}\\\"\""' \
  'bind-key | if-shell "echo \" $HOSTNAME me media bash ksh zsh csh sh \" | grep -q \" #{window_name} \"" "run-shell \"tmux split-window -h\"" "run-shell \"tmux split-window -h \\\"ssh #{window_name}\\\"\""'

# Split vertically for C-b," (if ssh'd to host, put that host in the split)
if-shell 'which tmux_winsplit' \
  'bind-key \" if-shell "tmux_winsplit #{window_name}" "run-shell \"tmux split-window\"" "run-shell \"tmux split-window \\\"ssh #{window_name}\\\"\""' \
  'bind-key \" if-shell "echo \" $HOSTNAME me media bash ksh zsh csh sh \" | grep -q \" #{window_name} \"" "run-shell \"tmux split-window\"" "run-shell \"tmux split-window \\\"ssh #{window_name}\\\"\""'
if-shell 'which tmux_winsplit' \
  'bind-key C-- if-shell "tmux_winsplit #{window_name}" "run-shell \"tmux split-window\"" "run-shell \"tmux split-window \\\"ssh #{window_name}\\\"\""' \
  'bind-key C-- if-shell "echo \" $HOSTNAME me media bash ksh zsh csh sh \" | grep -q \" #{window_name} \"" "run-shell \"tmux split-window\"" "run-shell \"tmux split-window \\\"ssh #{window_name}\\\"\""'
if-shell 'which tmux_winsplit' \
  'bind-key - if-shell "tmux_winsplit #{window_name}" "run-shell \"tmux split-window\"" "run-shell \"tmux split-window \\\"ssh #{window_name}\\\"\""' \
  'bind-key - if-shell "echo \" $HOSTNAME me media bash ksh zsh csh sh \" | grep -q \" #{window_name} \"" "run-shell \"tmux split-window\"" "run-shell \"tmux split-window \\\"ssh #{window_name}\\\"\""'

## C-b,k for konnect to SSH host in a new window
if-shell 'which tmux_groupssh' \
  'bind-key k command-prompt -p "#[fg=#{@fg_color}]Host (or list) to ssh to:" "run-shell \"tmux_groupssh -h %%\""' \
  'bind-key k command-prompt -p "#[fg=#{@fg_color}]Host (or list) to ssh to:" "run-shell \"g=\\\$(echo %%|sed \\\"s/,/ /g\\\");c=0;for f in \\\$g; do [ \\\$c = 0 ] && tmux new-window -n \\\$f \\\"ssh \\\$f\\\" || tmux split-window -t:\\\$ \\\"ssh \\\$f\\\"; c=\\\$((c+1));done;tmux select-layout -t:\\\$.0 tiled;tmux set -w -t:\\\$.0 synchronize-panes;tmux set -gw -t:\\\$.0 pane-active-border-style \\\"fg=#{@alert_color}\\\";tmux selectp -t:\\\$.0\""'

## C-b,K for konnect (bypassing known_hosts) to SSH host in a new window
if-shell 'which tmux_groupssh' \
  'bind-key K command-prompt -p "#[fg=#{@fg_color}]Host (or list) to ssh to (no known_hosts):" "run-shell \"tmux_groupssh -h -u %%\""' \
  'bind-key K command-prompt -p "#[fg=#{@fg_color}]Host (or list) to ssh to (no known_hosts):" "run-shell \"g=\\\$(echo %%|sed \\\"s/,/ /g\\\");c=0;for f in \\\$g; do [ \\\$c = 0 ] && tmux new-window -n \\\$f \\\"ssh -o GlobalKnownHostsFile=/dev/null -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no \\\$f\\\" || tmux split-window -t:\\\$ \\\"ssh -o GlobalKnownHostsFile=/dev/null -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no \\\$f\\\"; c=\\\$((c+1));done;tmux select-layout -t:\\\$.0 tiled;tmux set -w -t:\\\$.0 synchronize-panes;tmux set -gw -t:\\\$.0 pane-active-border-style \\\"fg=#{@alert_color}\\\";tmux selectp -t:\\\$.0\""'

## C-b,g for go to SSH host via ipv4 in a new window
if-shell 'which tmux_groupssh' \
  'bind-key g command-prompt -p "#[fg=#{@fg_color}]Host (or list) to ssh (ipv4) to:" "run-shell \"tmux_groupssh -h -4 %%\""' \
  'bind-key g command-prompt -p "#[fg=#{@fg_color}]Host (or list) to ssh (ipv4) to:" "run-shell \"g=\\\$(echo %%|sed \\\"s/,/ /g\\\");c=0;for f in \\\$g; do [ \\\$c = 0 ] && tmux new-window -n \\\$f \\\"ssh -4 \\\$f\\\" || tmux split-window -t:\\\$ \\\"ssh -4 \\\$f\\\"; c=\\\$((c+1));done;tmux select-layout -t:\\\$.0 tiled;tmux set -w -t:\\\$.0 synchronize-panes;tmux set -gw -t:\\\$.0 pane-active-border-style \\\"fg=#{@alert_color}\\\";tmux selectp -t:\\\$.0\""'

## C-b,G for go (bypassing known_hosts) via ipv4 to SSH host in a new window
if-shell 'which tmux_groupssh' \
  'bind-key G command-prompt -p "#[fg=#{@fg_color}]Host (or list) to ssh (ipv4) to (no known_hosts):" "run-shell \"tmux_groupssh -h -4 -u %%\""' \
  'bind-key G command-prompt -p "#[fg=#{@fg_color}]Host (or list) to ssh (ipv4) to (no known_hosts):" "run-shell \"g=\\\$(echo %%|sed \\\"s/,/ /g\\\");c=0;for f in \\\$g; do [ \\\$c = 0 ] && tmux new-window -n \\\$f \\\"ssh -4 -o GlobalKnownHostsFile=/dev/null -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no \\\$f\\\" || tmux split-window -t:\\\$ \\\"ssh -4 -o GlobalKnownHostsFile=/dev/null -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no \\\$f\\\"; c=\\\$((c+1));done;tmux select-layout -t:\\\$.0 tiled;tmux set -w -t:\\\$.0 synchronize-panes;tmux set -gw -t:\\\$.0 pane-active-border-style \\\"fg=#{@alert_color}\\\";tmux selectp -t:\\\$.0\""'

# C-b,j for join -- split this window and ssh to a specified host
bind-key j command-prompt -p "#[fg=#{@fg_color}]Host to ssh to (split):" "split-window -h 'ssh %1'"

# C-b,J for join -- split this window vertically and ssh to a specified host
bind-key J command-prompt -p "#[fg=#{@fg_color}]Host to ssh to (vsplit):" "split-window 'ssh %1'"

# C-b,h for half-join -- split this window and ssh via ipv4 to a specified host
bind-key h command-prompt -p "#[fg=#{@fg_color}]Host to ssh (ipv4) to (split):" "split-window -h 'ssh -4 %1'"

# C-b,H for half-join -- split this window vertically and ssh via ipv4 to a specified host
bind-key H command-prompt -p "#[fg=#{@fg_color}]Host to ssh (ipv4) to (vsplit):" "split-window 'ssh -4 %1'"

# C-b,n for new -- open a new window sshing to same host as current window
bind-key C-n run-shell 'tmux new-window -n "#{window_name}" "ssh #{window_name}"'

# Read any configuration from a local file (like: bind-key c new-window -n "mercury")
if-shell "test -e ~/.config/tmux/tmux.conf.local" "source-file ~/.config/tmux/tmux.conf.local"

