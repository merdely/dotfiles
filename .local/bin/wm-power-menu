#!/bin/bash

power_menu=wleave
power_opts="-x -f"
margin=330
[ -r $HOME/.config/powermenurc ] && source $HOME/.config/powermenurc

case $XDG_CURRENT_DESKTOP in
  sway*)
    eval $(swaymsg -r -t get_outputs | jq -r '.[] | select(.active==true) | "w=\(.rect.width) h=\(.rect.height)"')
    ;;
  niri*)
    eval $(niri msg -j focused-output | jq -r '"w=\(.logical.width) h=\(.logical.height)"')
    ;;
  Hyprland*)
    eval $(hyprctl -j monitors | jq -r '.[] | select(.focused==true) | "w=\(.width) h=\(.height)"')
    ;;
esac

[ $w -lt 1400 ] && margin=230
[ $h -lt 800 ] && margin=230

open_power_menu() {
  open_cmd=$power_menu
  opts="$power_opts -m $margin -b 4"
  rot_opts="$power_opts -m $margin -b 2"
  case $XDG_CURRENT_DESKTOP in
    sway*)
      xform=$(swaymsg -r -t get_outputs | jq -r '.[] | select(.focused == "true" | .transform')
      if [[ $xform = 90 ]] || [[ $xform = 270 ]]; then
        opts=$rot_opts
      fi
      swaymsg exec $open_cmd $opts &
      ;;
    niri*)
      xform=$(niri msg -j outputs | jq -r '.[].logical.transform')
      if [[ $xform = 90 ]] || [[ $xform = 270 ]]; then
        opts=$rot_opts
      fi
      niri msg action spawn -- $open_cmd $opts &
      ;;
    Hyprland)
      xform=$(hyprctl monitors -j | jq -r '.[] | select(.focused == true) | .transform')
      if [[ $((xform % 2)) = 1 ]]; then
        opts=$rot_opts
      fi
      hyprctl dispatch exec $open_cmd $opts &
      ;;
    *) exec $open_cmd $opts & ;;
  esac
}

pgrep -u $LOGNAME -x $power_menu && pkill -u $LOGNAME -x $power_menu || open_power_menu
