#!/bin/bash

close_drawer() {
  close_cmd="nwg-drawer -close"
  case $XDG_CURRENT_DESKTOP in
    sway*) swaymsg exec $close_cmd ;;
    niri*) niri msg action spawn -- $close_cmd ;;
    Hyprland) hyprctl dispatch exec $close_cmd ;;
    *) exec $* ;;
  esac
}

open_drawer() {
  open_cmd="nwg-drawer -closebtn right -nocats -mt 50 -mb 100 -ml 100 -mr 100 -c 5"
  rot_open_cmd="nwg-drawer -closebtn right -nocats -mt 100 -mb 250 -ml 20 -mr 20 -c 3 -is 32"
  if which uwsm &>/dev/null && uwsm check is-active; then
    open_cmd="uwsm app -- $open_cmd"
    rot_open_cmd="uwsm app -- $rot_open_cmd"
  fi
  case $XDG_CURRENT_DESKTOP in
    sway*)
      xform=$(swaymsg -r -t get_outputs | jq -r '.[] | select(.focused == "true" | .transform')
      if [[ $xform = 90 ]] || [[ $xform = 270 ]]; then
        open_cmd=$rot_open_cmd
      fi
      swaymsg exec $open_cmd &
      ;;
    niri*)
      xform=$(niri msg -j outputs | jq -r '.[].logical.transform')
      if [[ $xform = 90 ]] || [[ $xform = 270 ]]; then
        open_cmd=$rot_open_cmd
      fi
      niri msg action spawn -- $open_cmd &
      ;;
    Hyprland)
      xform=$(hyprctl monitors -j | jq -r '.[] | select(.focused == true) | .transform')
      if [[ $((xform % 2)) = 1 ]]; then
        open_cmd=$rot_open_cmd
      fi
      hyprctl dispatch exec $open_cmd &
      ;;
    *) exec $* ;;
  esac
}

pgrep -u $LOGNAME -x nwg-drawer && close_drawer || open_drawer
