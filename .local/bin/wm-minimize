#!/bin/bash

progname=$(basename $0)
usage() {
  echo "usage: $progname [-h] [-R] [-c] command|ACTIVE [windowclass] [title]"
  echo "         By default, $progname uses gtk-launch"
  echo "         With -c, $progname looks for a command string \"foo --bar --baz\""
  echo "         With -R, $progname will NOT resize windows to 90% when unminimizing"
  exit $1
}

niri_floating_ws="ðŸ—’ï¸"

resize_height=90%
resize_width=$resize_height
resize[galculator]="640|480"
[ -r $HOME/.config/wm-minimize.conf ] && source $HOME/.config/wm-minimize.conf

mode=desktop
resize=1
[ "$1" = "-h" -o "$1" = "--help" ] && usage
[ "$1" = "-c" ] && mode=cmdline && shift
[ "$1" = "-R" ] && resize=0 && shift
[ "$1" = "-c" ] && mode=cmdline && shift
[ -z "$1" ] && usage 1

cmd=$1
appid=$1
[ -n "$2" ] && appid=$2
[ -n "$3" ] && title=$3

toggle_minimize() {
  if [[ "$XDG_CURRENT_DESKTOP" =~ ^sway ]]; then
    scratchpad_search=$(swaymsg -r -t get_tree | jq --arg c "$1" -r '.nodes[].nodes[] | select(.name=="__i3_scratch").floating_nodes.[] | select(.app_id==$c).app_id')

    if [ "$scratchpad_search" = $1 ]; then
      # window is in scratchpad
      if [ -z "$2" ]; then
        swaymsg [app_id="$1"] scratchpad show
      else
        swaymsg "[app_id=\"$1\" title=\"$2\"] scratchpad show"
      fi
    else
      if [ -z "$2" ]; then
        swaymsg [app_id="$1"] move window to scratchpad
      else
        swaymsg "[app_id=\"$1\" title=\"$2\"] move window to scratchpad"
      fi
    fi

  elif [[ "$XDG_CURRENT_DESKTOP" =~ ^niri ]]; then
    if [ -z "$2" ]; then
      ws_id=$(niri msg -j windows | jq -r --arg c "$1" '.[] | select(.app_id==$c) | .workspace_id')
    else
      ws_id=$(niri msg -j windows | jq -r --arg c "$1" --arg t "$2" '.[] | select(.app_id==$c and .title==$t) | .workspace_id')
    fi
    [[ $ws_id ]] && ws_name=$(niri msg -j workspaces | jq -r --arg c $ws_id '.[] | select(.id|tostring==$c) | .name')
    cur_ws=$(niri msg -j focused-window | jq -r '.workspace_id')
    cur_mon=$(niri msg -j focused-output | jq -r '.name')
    if [ -z "$2" ]; then
      app_id=$(niri msg -j windows | jq -r --arg c "$1" '.[] | select(.app_id==$c) | .id')
    else
      app_id=$(niri msg -j windows | jq -r --arg c "$1" --arg t "$2" '.[] | select(.app_id==$c and .title==$t) | .id')
    fi

    if [ "$ws_name" = $niri_floating_ws ] || [ "$ws_id" != "$cur_ws" ]; then
      niri msg action move-window-to-floating --id $app_id
      niri msg action move-window-to-monitor --id $app_id $cur_mon
      niri msg action focus-window --id $app_id
      if [ -n "${new_height[$app_id]}" ]; then
        niri msg action set-window-height --id $app_id ${resize[$1]#*|}
        niri msg action set-window-width --id $app_id ${resize[$1]%|*}
      elif [ $resize = 1 ]; then
        niri msg action set-window-height --id $app_id $resize_height
        niri msg action set-window-width --id $app_id $resize_width
        sleep .1
      fi
      niri msg action center-window --id $app_id
    else
      niri msg action move-window-to-workspace --focus false --window-id $app_id $niri_floating_ws
      niri msg action move-window-to-tiling --id $app_id
      niri msg action set-window-width --id $app_id 100%
    fi

  else  # Hyprland

    ws=$(hyprctl workspaces -j | jq --arg w "special:$1" -r '.[] | select(.name == $w) | .id')
    mon=$(hyprctl monitors -j | jq --arg w "special:$1" -r '.[] | select(.specialWorkspace.name == $w) | .id')
    if [ -z "$2" ]; then
      app=$(hyprctl clients -j | jq --arg c "$1" -r '.[] | select(.class==$c) | .address')
    else
      app=$(hyprctl clients -j | jq --arg c "$1" --arg t "$2" -r '.[] | select(.class==$c and .title==$t) | .address')
    fi

    # if $mon is defined, window is assumed to be showing so hide it

    if [ -z "$mon" ] && [ -z "$ws" ]; then
      hyprctl dispatch movetoworkspacesilent special:"$1",address:$app
    else
      a_ws=$(hyprctl monitors -j | jq -r '.[] | select(.focused==true) | .activeWorkspace.id')
      hyprctl dispatch movetoworkspace $a_ws,address:$app
    fi
  fi
}

do_exec() {
  if [ $mode = desktop ]; then
    echo "gtk-launch $*"
  else
    echo "$*"
  fi
}

run_cmd() {
  if [[ "$XDG_CURRENT_DESKTOP" =~ ^sway ]]; then
    swaymsg exec $(do_exec $1)
  elif [[ "$XDG_CURRENT_DESKTOP" =~ ^niri ]]; then
    niri msg action spawn -- $(do_exec $1)
    unset app_id
    count=0
    while [ -z "$app_id" ] && [ $count -le 100 ]; do
      app_id=$(niri msg -j windows | jq -r --arg c "$2" '.[] | select(.app_id==$c) | .id')
      [ -z "$app_id" ] && count=$((count+1)) && sleep .1
    done
    if [ $count -ge 100 ]; then
      echo "Warning: Could not get window id" > /dev/stderr
    else
      if [ -n "${new_height[$app_id]}" ]; then
        niri msg action set-window-height --id $app_id ${resize[$1]#*|}
        niri msg action set-window-width --id $app_id ${resize[$1]%|*}
      elif [ $resize = 1 ]; then
        niri msg action set-window-height --id $app_id $resize_height
        niri msg action set-window-width --id $app_id $resize_width
        sleep .1
      fi
      niri msg action center-window --id $app_id
    fi
  else
    hyprctl dispatch exec $(do_exec $1)
  fi
}

isrunning() {
  if [[ "$XDG_CURRENT_DESKTOP" =~ ^sway ]]; then
    swaymsg -r -t get_tree | jq -r --arg c "$1" 'recurse(.nodes[]?, .floating_nodes[]?) | select(.app_id==$c) | .app_id' | grep -qE "^${1}$"
  elif [[ "$XDG_CURRENT_DESKTOP" =~ ^niri ]]; then
    niri msg -j windows | jq -r --arg c "$1" '.[] | select(.app_id==$c) | .app_id' | grep -qE "^${1}$"
  else
    hyprctl clients -j | jq -r --arg c "$1" '.[] | select(.class==$c) | .class' | grep -qE "^${1}$"
  fi
}

if [ $cmd = ACTIVE ]; then
  if [[ "$XDG_CURRENT_DESKTOP" =~ ^niri ]]; then
    if [ $(niri msg -j focused-window | jq -r .is_floating) = false ]; then
      echo "Warning: The active window is not a floating window... not minimizing" > /dev/stderr
      exit 0
    fi
    app_id=$(niri msg -j focused-window | jq '.id')
    ws_id=$(niri msg -j focused-window | jq '.workspace_id')
    [[ $ws_id ]] && ws_name=$(niri msg -j workspaces | jq -r --arg c $ws_id '.[] | select(.id|tostring==$c) | .name')
    #cur_mon=$(niri msg -j focused-output | jq -r '.name')
    if [ "$ws_name" = $niri_floating_ws ]; then
      niri msg action move-window-up-or-to-workspace-up
      niri msg action move-window-to-floating --id $app_id
      # niri msg action move-window-to-monitor --id $app_id $cur_mon
      niri msg action focus-window --id $app_id
      if [ -n "${new_height[$app_id]}" ]; then
        niri msg action set-window-height --id $app_id ${resize[$1]#*|}
        niri msg action set-window-width --id $app_id ${resize[$1]%|*}
      elif [ $resize = 1 ]; then
        niri msg action set-window-height --id $app_id $resize_height
        niri msg action set-window-width --id $app_id $resize_width
        sleep .1
      fi
      niri msg action center-window --id $app_id
    else
      niri msg action move-window-to-workspace --focus false --window-id $app_id $niri_floating_ws
      niri msg action move-window-to-tiling --id $app_id
      niri msg action set-window-width --id $app_id 100%
    fi
  fi
else
  isrunning "$appid" && toggle_minimize "$appid" "$title" || run_cmd "$cmd" "$appid" "$title"
fi

