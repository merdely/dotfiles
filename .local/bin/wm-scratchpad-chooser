#!/bin/bash

[ -r $XDG_CONFIG_HOME/app-launcher.conf ] && source $XDG_CONFIG_HOME/app-launcher.conf
chooser=$app_launcher

[ -z "$chooser" ] && chooser=fuzzel
[ "$1" = rofi ] && shift && chooser=rofi

scratchpad="ðŸ—’ï¸"
ws_id=$(niri msg -j workspaces | jq -r --arg sp "$scratchpad" '.[] | select(.name==$sp) | .id')
[ -z "$ws_id" ] && echo "Error: Could not determine Scratchpad Workspace" && exit 1

# List of running minimized apps
apps=$(niri msg -j windows | jq -r --arg ws "$ws_id" '.[] | select(.workspace_id|tostring==$ws) | "foo\t\(.app_id)\t\(.title)"')

# List of apps defined as minimizable apps in niri/config.kdl
apps2=$(awk '/^\s+[^#].*wm-minimize/ && ! /wm-minimize ACTIVE/ {a=b=$0;sub(/^.*hotkey-overlay-title="/,"",a);sub(/".*$/,"",a);sub(/^.*wm-minimize( -R)?/,"",b);sub(/"; }.*$/,"",b);split(b,z," ");b=c=z[1];if (z[2]) c=z[2];print b"\t"c"\t"a}' $HOME/.config/niri/config.kdl)

IFS="
"
unset running
# Grab the first column (app-id) of running apps into a list
for app in $apps; do 
  running="$running $(echo $app | awk '{print $2}')"
done
# Add any defined apps that are not running into the apps list
for app in $apps2; do 
  if ! echo "$running " | grep -q "$(echo $app | awk '{print $2}')"; then
    apps="$apps
$app"
  fi
done

# Print meaningless message about no apps find
[ -z "$apps" ] && echo "Error: Could not get list of Scratchpad Workspace Apps/Or no apps minimized" > /dev/stderr && exit 1

# Pipe list of apps through fuzzel
if [ $chooser = rofi ]; then
  app_id=$(echo "$apps" | rofi -p "Scratchpad App >" -dmenu -cache-dir $HOME/.cache/rofi_scratchpads -display-columns 3)
else
  app_id=$(echo "$apps" | fuzzel -p "Scratchpad App > " -d --cache=$HOME/.cache/fuzzel_scratchpad_chooser --with-nth=3 --accept-nth="{1..2}")
fi

# Exit if cancel
[ -z "$app_id" ] && exit 0

# Launch or unminimize an app
$HOME/.local/bin/wm-minimize $(echo $app_id | awk '{print $1}') $(echo $app_id | awk '{print $2}')
